datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * =========================
 * USERS & ROLES
 * =========================
 */

model User {
  id        Int      @id @default(autoincrement())
  name      String
  username  String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())

  treasuryEntries    TreasuryEntry[]     @relation("TreasuryEntryCreatedBy")
  paymentAllocations PaymentAllocation[] @relation("PaymentAllocationCreatedBy")
  auditLogs          AuditLog[]          @relation("AuditLogPerformedBy")
}

enum Role {
  ADMIN
  CASHIER
  STOREKEEPER
}

/**
 * =========================
 * CATALOG
 * =========================
 */

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  image       String?
  icon        String?
  color       String?
  createdAt   DateTime @default(now())

  products Product[]
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  categoryId  Int?
  brand       String?
  barcode     String?  @unique
  image       String?
  sku         String?  @unique
  basePrice   Decimal  @default(0) @db.Decimal(12, 2)
  cost        Decimal? @db.Decimal(12, 2)
  isActive    Boolean  @default(true)
  type        String   @default("store")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category     Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants     Variant[]
  productUnits ProductUnit[]
  inventory    Inventory?

  @@index([name])
  @@index([categoryId, updatedAt])
}

model ProductUnit {
  id               Int      @id @default(autoincrement())
  productId        Int
  unitName         String
  conversionFactor Float    @default(1)
  salePrice        Decimal  @default(0) @db.Decimal(12, 2)
  wholesalePrice   Decimal  @default(0) @db.Decimal(12, 2)
  minSalePrice     Decimal  @default(0) @db.Decimal(12, 2)
  purchasePrice    Decimal  @default(0) @db.Decimal(12, 2)
  barcode          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([barcode])
}

model Variant {
  id          Int      @id @default(autoincrement())
  productId   Int
  productSize String
  color       String
  price       Decimal  @db.Decimal(12, 2)
  cost        Decimal  @db.Decimal(12, 2)
  quantity    Int
  barcode     String?  @unique
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]
  returnItems   ReturnItem[]
  purchaseReturnItems PurchaseReturnItem[]

  @@unique([productId, productSize, color])
  @@index([productId])
}

model Inventory {
  id            Int       @id @default(autoincrement())
  productId     Int       @unique
  totalQuantity Int       @default(0)
  minStock      Int       @default(5)
  maxStock      Int       @default(100)
  warehouseQty  Int       @default(0)
  displayQty    Int       @default(0)
  lastRestock   DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

/**
 * =========================
 * CUSTOMERS & ACCOUNTING
 * =========================
 */

model Customer {
  id                  Int       @id @default(autoincrement())
  name                String
  phone               String?
  phone2              String?
  address             String?
  city                String?
  district            String?
  notes               String?
  creditLimit         Float     @default(0)
  balance             Float     @default(0)
  firstActivityDate   DateTime?
  lastPaymentDate     DateTime?
  financialsUpdatedAt DateTime?
  customerType        String    @default("عادي")
  rating              Float     @default(0)
  createdAt           DateTime  @default(now())

  sales              Sale[]
  returns            Return[]
  payments           CustomerPayment[]
  transactions       CustomerTransaction[]
  paymentAllocations PaymentAllocation[]

  @@index([name])
  @@index([phone])
  @@index([city])
  @@index([customerType])
  @@index([financialsUpdatedAt])
  @@index([balance])
  @@index([lastPaymentDate])
  @@index([createdAt])
  @@index([customerType, city])
}

model CustomerTransaction {
  id         Int      @id @default(autoincrement())
  customerId Int
  date       DateTime @default(now())

  type          TransactionType
  referenceType ReferenceType?
  referenceId   Int?

  debit  Float   @default(0)
  credit Float   @default(0)
  notes  String?

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, date])
  @@index([type])
  @@index([referenceType, referenceId])
}

enum TransactionType {
  SALE
  PAYMENT
  RETURN
  DISCOUNT
  ADJUSTMENT
}

enum ReferenceType {
  SALE
  PAYMENT
  RETURN
}

/**
 * =========================
 * SALES
 * =========================
 */

model Sale {
  id              Int      @id @default(autoincrement())
  customerId      Int?
  paymentMethodId Int?
  total           Float
  discount        Float    @default(0)
  saleType        String   @default("نقدي")
  notes           String?
  invoiceDate     DateTime @default(now())
  createdAt       DateTime @default(now())

  customer           Customer?           @relation(fields: [customerId], references: [id], onDelete: SetNull)
  paymentMethod      PaymentMethod?      @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  items              SaleItem[]
  returns            Return[]
  paymentAllocations PaymentAllocation[]

  @@index([customerId])
  @@index([paymentMethodId])
  @@index([customerId, invoiceDate])
}

model SaleItem {
  id        Int
  saleId    Int
  variantId Int
  quantity  Int
  price     Float
  discount  Float @default(0)

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id])

  @@id([id, saleId])
}

/**
 * =========================
 * RETURNS
 * =========================
 */

model Return {
  id         Int      @id @default(autoincrement())
  saleId     Int?
  customerId Int?
  total      Float
  notes      String?
  createdAt  DateTime @default(now())

  sale     Sale?        @relation(fields: [saleId], references: [id], onDelete: SetNull)
  customer Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items    ReturnItem[]
}

model ReturnItem {
  id        Int
  returnId  Int
  variantId Int
  quantity  Int
  price     Float

  return  Return  @relation(fields: [returnId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id])

  @@id([id, returnId])
}

/**
 * =========================
 * PAYMENTS
 * =========================
 */

model PaymentMethod {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  code      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  sales           Sale[]
  payments        CustomerPayment[]
  treasuryEntries TreasuryEntry[]
}

model CustomerPayment {
  id              Int      @id @default(autoincrement())
  customerId      Int
  paymentMethodId Int
  amount          Float
  notes           String?
  paymentDate     DateTime @default(now())

  customer           Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  paymentMethod      PaymentMethod       @relation(fields: [paymentMethodId], references: [id])
  paymentAllocations PaymentAllocation[]

  @@index([customerId])
  @@index([customerId, paymentDate])
}

/**
 * =========================
 * SUPPLIERS (BASIC)
 * =========================
 */

model Supplier {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  address   String?
  balance   Float    @default(0)
  createdAt DateTime @default(now())

  purchases       Purchase[]
  purchaseReturns PurchaseReturn[]
  payments        SupplierPayment[]
}

model Purchase {
  id         Int      @id @default(autoincrement())
  supplierId Int?
  total      Float
  paid       Float    @default(0)
  notes      String?
  createdAt  DateTime @default(now())

  supplier Supplier?       @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  items    PurchaseItem[]
  returns  PurchaseReturn[]
}

model PurchaseItem {
  id         Int
  purchaseId Int
  variantId  Int
  quantity   Int
  cost       Float

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  variant  Variant  @relation(fields: [variantId], references: [id])

  @@id([id, purchaseId])
}

model PurchaseReturn {
  id         Int      @id @default(autoincrement())
  purchaseId Int?
  supplierId Int?
  total      Float
  notes      String?
  createdAt  DateTime @default(now())

  purchase Purchase?          @relation(fields: [purchaseId], references: [id], onDelete: SetNull)
  supplier Supplier?          @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  items    PurchaseReturnItem[]

  @@index([purchaseId])
  @@index([supplierId])
}

model PurchaseReturnItem {
  id               Int
  purchaseReturnId Int
  variantId        Int
  quantity         Int
  price            Float

  purchaseReturn PurchaseReturn @relation(fields: [purchaseReturnId], references: [id], onDelete: Cascade)
  variant        Variant        @relation(fields: [variantId], references: [id])

  @@id([id, purchaseReturnId])
}

model SupplierPayment {
  id         Int      @id @default(autoincrement())
  supplierId Int
  amount     Float
  notes      String?
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

/**
 * =========================
 * EXPENSES
 * =========================
 */

model ExpenseCategory {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  color     String?
  icon      String?
  createdAt DateTime @default(now())

  expenses Expense[]
}

model Expense {
  id          Int      @id @default(autoincrement())
  title       String
  amount      Float
  categoryId  Int?
  notes       String?
  expenseDate DateTime @default(now())
  createdAt   DateTime @default(now())

  category ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([categoryId])
  @@index([expenseDate])
}

/**
 * =========================
 * TREASURY
 * =========================
 */

enum TreasuryDirection {
  IN
  OUT
}

enum TreasuryEntryType {
  OPENING_BALANCE
  SALE_INCOME
  CUSTOMER_PAYMENT
  DEPOSIT_IN
  DEPOSIT_REFUND
  MANUAL_IN
  EXPENSE_PAYMENT
  PURCHASE_PAYMENT
  SUPPLIER_PAYMENT
  RETURN_REFUND
  MANUAL_OUT
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
}

enum PaymentAllocationSourceType {
  CUSTOMER_PAYMENT
  DEPOSIT
}

model Treasury {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  code           String   @unique
  description    String?
  openingBalance Float    @default(0)
  currentBalance Float    @default(0)
  isActive       Boolean  @default(true)
  isDefault      Boolean  @default(false)
  isDeleted      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  entries               TreasuryEntry[] @relation("TreasuryMain")
  sourceTransferEntries TreasuryEntry[] @relation("TreasuryTransferSource")
  targetTransferEntries TreasuryEntry[] @relation("TreasuryTransferTarget")
  auditLogs             AuditLog[]

  @@index([isActive])
  @@index([isDefault])
  @@index([isDeleted])
}

model TreasuryEntry {
  id               Int               @id @default(autoincrement())
  treasuryId       Int
  entryType        TreasuryEntryType
  direction        TreasuryDirection
  amount           Float
  balanceBefore    Float             @default(0)
  balanceAfter     Float             @default(0)
  notes            String?
  note             String?
  referenceType    String?
  referenceId      Int?
  paymentMethodId  Int?
  idempotencyKey   String?           @unique
  createdByUserId  Int?
  meta             Json?
  sourceTreasuryId Int?
  targetTreasuryId Int?
  entryDate        DateTime          @default(now())
  createdAt        DateTime          @default(now())

  treasury                 Treasury            @relation("TreasuryMain", fields: [treasuryId], references: [id], onDelete: Cascade)
  paymentMethod            PaymentMethod?      @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  createdByUser            User?               @relation("TreasuryEntryCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  sourceTreasury           Treasury?           @relation("TreasuryTransferSource", fields: [sourceTreasuryId], references: [id], onDelete: SetNull)
  targetTreasury           Treasury?           @relation("TreasuryTransferTarget", fields: [targetTreasuryId], references: [id], onDelete: SetNull)
  paymentAllocationsSource PaymentAllocation[] @relation("PaymentAllocationSourceEntry")
  auditLogs                AuditLog[]

  @@index([treasuryId, entryDate])
  @@index([treasuryId, createdAt])
  @@index([entryType])
  @@index([entryType, createdAt])
  @@index([direction])
  @@index([referenceType, referenceId])
  @@index([paymentMethodId])
  @@index([paymentMethodId, createdAt])
}

model PaymentAllocation {
  id                Int                         @id @default(autoincrement())
  customerId        Int?
  saleId            Int
  sourceType        PaymentAllocationSourceType
  customerPaymentId Int?
  treasuryEntryId   Int?
  amount            Float
  allocationDate    DateTime                    @default(now())
  note              String?
  meta              Json?
  createdByUserId   Int?
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt

  customer        Customer?        @relation(fields: [customerId], references: [id], onDelete: SetNull)
  sale            Sale             @relation(fields: [saleId], references: [id], onDelete: Cascade)
  customerPayment CustomerPayment? @relation(fields: [customerPaymentId], references: [id], onDelete: Cascade)
  treasuryEntry   TreasuryEntry?   @relation("PaymentAllocationSourceEntry", fields: [treasuryEntryId], references: [id], onDelete: SetNull)
  createdBy       User?            @relation("PaymentAllocationCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([saleId, allocationDate])
  @@index([customerPaymentId])
  @@index([treasuryEntryId])
  @@index([sourceType, allocationDate])
  @@index([customerId, allocationDate])
}

model AuditLog {
  id                Int      @id @default(autoincrement())
  action            String
  entityType        String
  entityId          String?
  treasuryId        Int?
  treasuryEntryId   Int?
  referenceType     String?
  referenceId       Int?
  performedByUserId Int?
  note              String?
  meta              Json?
  createdAt         DateTime @default(now())

  treasury      Treasury?      @relation(fields: [treasuryId], references: [id], onDelete: SetNull)
  treasuryEntry TreasuryEntry? @relation(fields: [treasuryEntryId], references: [id], onDelete: SetNull)
  performedBy   User?          @relation("AuditLogPerformedBy", fields: [performedByUserId], references: [id], onDelete: SetNull)

  @@index([action, createdAt])
  @@index([entityType, entityId])
  @@index([treasuryId, createdAt])
  @@index([treasuryEntryId, createdAt])
  @@index([referenceType, referenceId])
}
